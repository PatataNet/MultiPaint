namespace SpriteKind {
    export const Trailing = SpriteKind.create()
}
sprites.onCreated(SpriteKind.Trailing, function (sprite) {
    sprite.setStayInScreen(true)
    sprite.setFlag(SpriteFlag.Invisible, true)
})
ControllerButton.B.onButtonEvent(controller.player2, ControllerButtonEvent.Pressed, function () {
    changeBrushSize(1)
})
function changeBrushSize (index: number) {
    sizeIndicator = sprites.create(img`
        . . 1 1 1 1 1 1 1 1 1 1 1 1 . 
        . 1 1 1 1 1 1 1 1 1 1 1 1 1 . 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 
        . 1 1 1 1 1 1 1 1 1 1 1 1 1 . 
        . . 1 1 1 1 1 1 1 1 1 1 1 . . 
        . . . . . . 1 1 1 . . . . . . 
        . . . . . . . 1 . . . . . . . 
        `, SpriteKind.Player)
    sizeIndicator.x = players[index].x
    sizeIndicator.bottom = players[index].x
    sizeIndicator.lifespan = 750
    brushSize[index] = Math.max(1, (brushSize[index] + 1) % 7)
    spriteutils.fillCircle(
    sizeIndicator.image,
    7,
    6,
    brushSize[index],
    brushColors[index]
    )
}
ControllerButtonEvent.Pressed.onEvent(controller.menu, function () {
    scene.setBackgroundImage(img`
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        ................................................................................................................................................................
        `)
})
function startPaint (index: number) {
    spriteutils.placeAngleFrom(
    trailingSprites[index],
    0,
    0,
    players[index]
    )
    spriteutils.placeAngleFrom(
    followingSprites[index],
    0,
    0,
    players[index]
    )
}
function paintLine (color: number, radius: number, fromSprite: Sprite, toSprite: Sprite) {
    angle = spriteutils.angleFrom(toSprite, fromSprite)
    distance = spriteutils.distanceBetween(fromSprite, toSprite)
    while (true) {
        spriteutils.placeAngleFrom(
        fromSprite,
        angle,
        distance,
        toSprite
        )
        spriteutils.fillCircle(
        scene.backgroundImage(),
        Math.round(fromSprite.x),
        Math.round(fromSprite.x),
        radius,
        color
        )
        distance += -1
        if (distance <= 0) {
            break;
        }
    }
    spriteutils.placeAngleFrom(
    fromSprite,
    0,
    0,
    toSprite
    )
}
sprites.onCreated(SpriteKind.Player, function (sprite) {
    sprite.setStayInScreen(true)
})
let targetAngle = 0
let distance = 0
let angle = 0
let sizeIndicator: Sprite = null
let followingSprites: Sprite[] = []
let trailingSprites: Sprite[] = []
let players: Sprite[] = []
let brushSize: number[] = []
let brushColors: number[] = []
scene.setBackgroundImage(img`
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    ................................................................................................................................................................
    `)
let p1 = sprites.create(img`
    . . . f . . . 
    . . f 2 f . . 
    . f f 2 f f . 
    f 2 2 2 2 2 f 
    . f f 2 f f . 
    . . f 2 f . . 
    . . . f . . . 
    `, SpriteKind.Player)
p1.setPosition(30, 30)
let p2 = sprites.create(img`
    . . . f . . . 
    . . f 8 f . . 
    . f f 8 f f . 
    f 8 8 8 8 8 f 
    . f f 8 f f . 
    . . f 8 f . . 
    . . . f . . . 
    `, SpriteKind.Player)
p2.setPosition(130, 30)
let p3 = sprites.create(img`
    . . . f . . . 
    . . f 4 f . . 
    . f f 4 f f . 
    f 4 4 4 4 4 f 
    . f f 4 f f . 
    . . f 4 f . . 
    . . . f . . . 
    `, SpriteKind.Player)
p3.setPosition(30, 90)
let p4 = sprites.create(img`
    . . . f . . . 
    . . f 6 f . . 
    . f f 6 f f . 
    f 6 6 6 6 6 f 
    . f f 6 f f . 
    . . f 6 f . . 
    . . . f . . . 
    `, SpriteKind.Player)
p4.setPosition(130, 90)
controller.player1.moveSprite(p1, 50, 50)
controller.player2.moveSprite(p2, 50, 50)
controller.player3.moveSprite(p3, 50, 50)
controller.player4.moveSprite(p4, 50, 50)
brushColors = [
2,
8,
4,
6
]
brushSize = [
3,
3,
3,
3
]
players = [
p1,
p2,
p3,
p4
]
trailingSprites = [
sprites.create(img`
    . . . f . . . 
    . . f 2 f . . 
    . f f 2 f f . 
    f 2 2 2 2 2 f 
    . f f 2 f f . 
    . . f 2 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing),
sprites.create(img`
    . . . f . . . 
    . . f 2 f . . 
    . f f 2 f f . 
    f 2 2 2 2 2 f 
    . f f 2 f f . 
    . . f 2 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing),
sprites.create(img`
    . . . f . . . 
    . . f 2 f . . 
    . f f 2 f f . 
    f 2 2 2 2 2 f 
    . f f 2 f f . 
    . . f 2 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing),
sprites.create(img`
    . . . f . . . 
    . . f 2 f . . 
    . f f 2 f f . 
    f 2 2 2 2 2 f 
    . f f 2 f f . 
    . . f 2 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing)
]
followingSprites = [
sprites.create(img`
    . . . f . . . 
    . . f 2 f . . 
    . f f 2 f f . 
    f 2 2 2 2 2 f 
    . f f 2 f f . 
    . . f 2 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing),
sprites.create(img`
    . . . f . . . 
    . . f 8 f . . 
    . f f 8 f f . 
    f 8 8 8 8 8 f 
    . f f 8 f f . 
    . . f 8 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing),
sprites.create(img`
    . . . f . . . 
    . . f 4 f . . 
    . f f 4 f f . 
    f 4 4 4 4 4 f 
    . f f 4 f f . 
    . . f 4 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing),
sprites.create(img`
    . . . f . . . 
    . . f 6 f . . 
    . f f 6 f f . 
    f 6 6 6 6 6 f 
    . f f 6 f f . 
    . . f 6 f . . 
    . . . f . . . 
    `, SpriteKind.Trailing)
]
let turnRate = 0.2
game.onUpdate(function () {
    if (controller.player1.isPressed(ControllerButton.A)) {
        paintLine(2, brushSize[0], trailingSprites[0], followingSprites[0])
    }
    if (controller.player2.isPressed(ControllerButton.A)) {
        paintLine(8, brushSize[1], trailingSprites[1], followingSprites[1])
    }
    if (controller.player3.isPressed(ControllerButton.A)) {
        paintLine(4, brushSize[2], trailingSprites[2], followingSprites[2])
    }
    if (controller.player4.isPressed(ControllerButton.A)) {
        paintLine(6, brushSize[3], trailingSprites[3], followingSprites[3])
    }
    for (let index = 0; index <= 3; index++) {
        angle = Math.atan2(followingSprites[index].x, followingSprites[index].x)
        if (angle < 0) {
            angle += 2 * spriteutils.consts(spriteutils.Consts.Pi)
        }
        targetAngle = spriteutils.angleFrom(followingSprites[index], players[index])
        if (targetAngle < 0) {
            targetAngle += 2 * spriteutils.consts(spriteutils.Consts.Pi)
        }
        if (Math.abs(targetAngle - angle) > spriteutils.consts(spriteutils.Consts.Pi)) {
            if (angle < targetAngle) {
                angle += 0 - turnRate
            } else {
                angle += turnRate
            }
        } else {
            if (angle < targetAngle) {
                angle += turnRate
            } else {
                angle += 0 - turnRate
            }
        }
        if (angle < 0) {
            angle += 2 * spriteutils.consts(spriteutils.Consts.Pi)
        }
        spriteutils.setVelocityAtAngle(followingSprites[index], angle, 6 * Math.min(10, spriteutils.distanceBetween(followingSprites[index], players[index])))
    }
})
